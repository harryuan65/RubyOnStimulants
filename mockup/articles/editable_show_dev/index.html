<!DOCTYPE html>
<html>

<head>
  <title>Postgres: Query string - ActiveMine</title>
  <meta name="csrf-param" content="authenticity_token" />
  <meta name="csrf-token"
    content="O1ncNSbJ9uPhDJ7A2AL6W2DatBsWvhgNqHZ2pfl9GT3fz+cDqRinKuebBZeMuBbqGowrOZk97gsxrAmDzL/RSQ==" />

  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>
  <script src="../../../app/assets/javascripts/highlight/highlight.js"></script>
  <script src="./articles.js"></script>
  <link rel="stylesheet" media="screen" href="../../../app/assets/stylesheets/markdown/github.css" />
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="wrap-alert" id="wrap-alert">
  </div>
  <div id="confirm-bkg" class="confirm-bkg">
    <div class="confirm-container">
      <div class="wrap-confirm-text-all">
        <div class="wrap-confirm-text">
          <h1 class="contirm-title notosans text-dk">Are You Sure?</h1>
          <h4 class="confirm-message notosans text-dk">All you changes will be lost.</h4>
        </div>
        <div class="x notosans text-dk" onclick="closeConfirm()">&#x2715;</div>
      </div>
      <div class="wrap-confirm-btns confirm">
        <button id="no" class="btn cancel notosans text-e7" onclick="closeConfirm()">&#x2715; No</button>
        <input id="yes" type="submit" class="btn yes notosans text-e7" onclick="history.go(-1);return false;"
          value="&#x25EF; Yes">
      </div>
    </div>
  </div>
  <nav id="nav-top">
    <a class="techpod notosans" href="/">TECHPOD</a>
    <div class="wrap-user-stats">
      <a class="user-stat text-dk notosans new-article pen" href="/articles/new">&#x270e;</a>

      <img src="https://lh3.googleusercontent.com/a-/AOh14GgmaCscPk5hJoDb4XKHvDIeC3XP6s4pvruNN-u98w=s96-c" alt="img"
        class="nav-profile-img crop-circle">

      <a class="user-stat text-dk notosans username" href="javascript:void(0)">harryuan.65</a>
      <a class="user-stat text-dk notosans" data-confirm="Confirm sign out ?" rel="nofollow" data-method="delete"
        href="/users/sign_out">Logout</a>
    </div>
  </nav>
  <div class="nav-side-toggle idle" id="nav-side-toggle" onclick="toggleSideNav()">&#x2630;</div>

  <nav id="nav-side" class="no-dark">
    <div id="nav-side-menu-container">
      <div class="nav-side-block">
        <h2 class="nav-side-block-title notosans text-a9"><a class="notosans text-d3" href="/news">News</a>
        </h2>
        <h2 class="nav-side-block-title notosans text-a9"><a class="notosans text-d3"
            href="/articles">Articles</a></h2>
        <hr class="nav-side-block-hr">
        <div class="nav-side-block-content-container">
          <h3 class="nav-side-block-content"><a class="notosans text-d3" href="/articles">All</a></h3>
        </div>
      </div>

      <div class="nav-side-block">
        <h2 class="nav-side-block-title notosans text-a9">Tools</h2>
        <hr class="nav-side-block-hr">
        <div class="nav-side-block-content-container">
          <h3 class="nav-side-block-content"><a class="notosans text-d3"
              href="https://harryuan65.github.io/CanvasColorPicker/">ColorPicker</a></h3>
          <h3 class="nav-side-block-content"><a class="notosans text-d3" href="/words">WordBook</a></h3>
          <h3 class="nav-side-block-content"><a class="notosans text-d3" href="/to_do_lists">ToDoList</a></h3>
          <!-- <h3 class="nav-side-block-content"><a class="notosans text-d3" href="javascript:void(0)">MyPurchases</a></h3> %>-->
        </div>
      </div>
    </div>

    <div class="nav-side-block">
      <h2 class="nav-side-block-title notosans text-a9">About</h2>
      <hr class="nav-side-block-hr">
      <div class="nav-side-block-content-container">
        <h3 class="nav-side-block-content"><a class="notosans text-d3"
            href="https://harryuan65.github.io/">Author</a></h3>
        <!-- <h3 class="nav-side-block-content"><a class="notosans text-d3" href="javascript:void(0)">WordCards</a></h3>-->
      </div>
    </div>
    </div>
  </nav>
  <main id="main">
    <div id="container">
      <div class="wrap-article show">
        <div class="wrap-title can-edit">
          <h1 id="article_18" class="article-page-title notosans text-dk">Postgres: Query string</h1>
          <div class="wrap-pen">
            <a href="/articles/18/edit" class="article-page-edit text-7e pen">&#x270E;</a>
          </div>
          <!-- <span class="article-page-subtitle show notosans text-7e"></span>-->
          <span class="article-page-tag show notosans text-7e">tags:
            <span class="tag-text">postgresql</span>
            <span class="notosans">,</span>
            <span class="tag-text">db</span>
          </span>
          <span class="article-page-author show notosans text-dk">harryuan.65</span>
          <span class="article-page-created-at notosans text-7e">Mon, 26 Oct 2020</span>

        </div>

        <hr>
        <div id="article-page-content" class="article-page-content show markdown text-dk" contenteditable>


        </div>

        <footer>
          <img src="https://lh3.googleusercontent.com/a-/AOh14GgmaCscPk5hJoDb4XKHvDIeC3XP6s4pvruNN-u98w=s96-c" alt=""
            class="crop-circle">
          <div class="wrap-author-info">
            <h1 class="author-name notosans text-5b">Harry Yuan</h1>
            <p class="author-desc notosans text-7e">Rails Developer</p>
          </div>
        </footer>
      </div>
    </div>
    <script>
      $(document).on('turbolinks:load', (e) => {
        $(".wrap-article.show").ready(function (e) {
          document.querySelectorAll('pre code').forEach(e => {
            hljs.highlightBlock(e);
          })
        })
      })
    </script>
  </main>
</body>

</html>

<!-- <h1>Scenario</h1>

          <p>前人建了一個Courses Table，其中有一個欄位叫做supported_languages，他是一個string (varchar(255))</p>

          <h2>courses</h2>

          <table>
            <thead>
              <tr>
                <th style="text-align: left">id</th>
                <th style="text-align: left">name</th>
                <th style="text-align: left">supported_languages</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="text-align: left">143</td>
                <td style="text-align: left">Ruby on Rails: 進階課程</td>
                <td style="text-align: left">2</td>
              </tr>
              <tr>
                <td style="text-align: left">144</td>
                <td style="text-align: left">Tensorflow for beginners</td>
                <td style="text-align: left">1,2,3,11</td>
              </tr>
              <tr>
                <td style="text-align: left">145</td>
                <td style="text-align: left">Postgresql: Хорошая база данных</td>
                <td style="text-align: left">1,3,11</td>
              </tr>
              <tr>
                <td style="text-align: left">146</td>
                <td style="text-align: left">React: Powerful Library for Single Page Applications</td>
                <td style="text-align: left">1,2,3,8</td>
              </tr>
            </tbody>
          </table>

          <h2>users</h2>

          <table>
            <thead>
              <tr>
                <th style="text-align: left">id</th>
                <th style="text-align: left">name</th>
                <th style="text-align: left">accept_languages</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="text-align: left">1</td>
                <td style="text-align: left">김정은</td>
                <td style="text-align: left">1,4</td>
              </tr>
              <tr>
                <td style="text-align: left">2</td>
                <td style="text-align: left">Иван</td>
                <td style="text-align: left">1,2,5,11</td>
              </tr>
              <tr>
                <td style="text-align: left">3</td>
                <td style="text-align: left">Abdul</td>
                <td style="text-align: left">1,8</td>
              </tr>
              <tr>
                <td style="text-align: left">4</td>
                <td style="text-align: left">小明</td>
                <td style="text-align: left">2</td>
              </tr>
              <tr>
                <td style="text-align: left">5</td>
                <td style="text-align: left">Jack</td>
                <td style="text-align: left">1</td>
              </tr>
            </tbody>
          </table>

          <h2>Document</h2>

          <p>假設公司文件規定數字、語言對應：</p>

          <pre><code class="json">[
  {1: &quot;English&quot;},
  {2: &quot;中文&quot;},
  {3: &quot;日本語&quot;},
  {4: &quot;한국어&quot;},
  {5: &quot;Español&quot;},
  {6: &quot;Português&quot;}
  {7: &quot;Türkçe&quot;},
  {8: &quot;العربية&quot;},
  {9: &quot;Ελληνικά&quot;},
  {10: &quot;Dansk&quot;},
  {11: &quot;Русский&quot;}
]
</code></pre>

          <h1>需求？</h1>

          <p>GET /courses/index 要回傳符合用戶語言的課程。</p>

          <p>假設current_user是<strong>小明</strong>，他需求語言是
            <code>&quot;2&quot;</code>，所以我們要回傳<strong>143,145,146</strong>的課程給他。</p>

          <p>我心想：是要怎樣query string 中的數字？</p>

          <h1>First attempt</h1>

          <p>第一個想到就是直接用pg的pattern matching。</p>

          <p>列了一下各種可能，這些都是我要的：<br>
            <code>&quot;2&quot;</code>, <code>&quot;1,2&quot;</code>, <code>&quot;2,3&quot;</code>,
            <code>&quot;1,2,3&quot;</code> </p>

          <pre><code class="sql">select * from courses
where support_languages ~ &#39;(^2$|,2$|^2,|,2,)&#39;
</code></pre>

          <p>results:</p>

          <table>
            <thead>
              <tr>
                <th style="text-align: left">id</th>
                <th style="text-align: left">name</th>
                <th style="text-align: left">supported_languages</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="text-align: left">143</td>
                <td style="text-align: left">Ruby on Rails: 進階課程</td>
                <td style="text-align: left">2</td>
              </tr>
              <tr>
                <td style="text-align: left">144</td>
                <td style="text-align: left">Tensorflow for beginners</td>
                <td style="text-align: left">1,2,3,11</td>
              </tr>
              <tr>
                <td style="text-align: left">146</td>
                <td style="text-align: left">React: Powerful Library for Single Page Applications</td>
                <td style="text-align: left">1,2,3,8</td>
              </tr>
            </tbody>
          </table>

          <p>看起來還行，但是如果我今天是<strong>김정은</strong>怎麼辦？</p>

          <pre><code class="sql">select * from courses
where support_languages ~ &#39;(^1$|,1$|^1,|,1,)&#39; or support_languages ~ &#39;(^4$|,4$|^4,|,4,)&#39;
</code></pre>

          <p>如果要搜的語言越來越多，是不是query會越來越肥？這樣我就要動態去append一堆重複的條件上去。</p>

          <p>詢問了一下我們data的專業大大<strong>傑克</strong>，他說可以用pg的json來亂兜。<br>
            蛤？亂兜？</p>

          <h1>原理</h1>

          <p>首先我們把 <strong>&#39;1,2,3&#39;</strong> 頭尾加上 <strong>&#39;[&#39;</strong>,
            <strong>&#39;]&#39;</strong>，再轉成jsonb</p>

          <pre><code class="sql">select &#39;[1,2,3]&#39;::jsonb
</code></pre>

          <p>接著我們使用postgres提供的contain operator <code>@&gt;</code><br>
            問他說<code>&#39;[1,2,3]&#39;::jsonb</code> 有沒有包含 <code>&#39;[2]&#39;::jsonb</code></p>

          <pre><code class="sql">select (case when (&#39;[1,2,3]&#39;::jsonb @&gt; &#39;[2]&#39;::jsonb) then true else false end)
</code></pre>

          <p>欸靠腰真的回傳true欸</p>

          <table>
            <thead>
              <tr>
                <th style="text-align: left">case</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="text-align: left">true</td>
              </tr>
            </tbody>
          </table>

          <p>結束！YAY</p>

          <pre><code class="sql">select id, name, support_languages
from users
where (&#39;[&#39; || support_languages || &#39;]&#39;)::jsonb @&gt; &#39;[1,8]&#39;::jsonb
</code></pre>

          <p>results:</p>

          <table>
            <thead>
              <tr>
                <th style="text-align: left">id</th>
                <th style="text-align: left">name</th>
                <th style="text-align: left">supported_languages</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="text-align: left">144</td>
                <td style="text-align: left">Tensorflow for beginners</td>
                <td style="text-align: left">1,2,3,11</td>
              </tr>
              <tr>
                <td style="text-align: left">145</td>
                <td style="text-align: left">Postgresql: Хорошая база данных</td>
                <td style="text-align: left">1,3,11</td>
              </tr>
              <tr>
                <td style="text-align: left">146</td>
                <td style="text-align: left">React: Powerful Library for Single Page Applications</td>
                <td style="text-align: left">1,2,3,8</td>
              </tr>
            </tbody>
          </table>

          <h1>References</h1>

          <p>Data的同事<br>
            <a href="https://www.postgresql.org/docs/current/functions-json.html">json functions - pgdoc</a><br>
            <a
              href="https://stackoverflow.com/questions/48321403/postgres-jsonb-int-array-contains-any-of-array-values">stackoverflow
              - json contain operator</a><br>
            <a href="https://stackoverflow.com/questions/36985926/what-does-the-operator-in-postgres-do">stackoverflow -
              what does @&gt; mean?</a></p> -->